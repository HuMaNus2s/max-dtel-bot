# MAX-бот с REST API для рассылки сообщений в группы

Учебный проект: сервис для отправки сообщений в группы мессенджера MAX через собственный REST API с управлением доступом по API-ключам.

## Описание проекта

Сервис предоставляет контролируемый способ отправки текстовых сообщений в заранее заданные группы MAX по мнемоническим именам (алиасам).  
Доступ к рассылке регулируется уникальными API-ключами, каждый из которых может быть привязан к одной или нескольким группам.

Проект предназначен для отработки навыков:
- проектирования и реализации REST API
- работы с базой данных (схема + миграции)
- аутентификации по токену/ключу
- интеграции с внешним мессенджер-API
- обработки ошибок и валидации входных данных

## Основные возможности

- Привязка мнемонических имён групп (`dev_team`, `marketing`, `all`) к реальным ID чатов MAX
- Управление правами отправки сообщений через API-ключи
- Отправка сообщений в одну или несколько групп по мнемоническому имени через HTTP-запрос
- Возврат структурированных JSON-ответов с кодами состояния и описанием ошибок
- Базовая защита от некорректных запросов и ошибок внешнего API

## Текущий REST API

### POST /send

Отправка сообщения в группу(-ы).

**Тело запроса** (application/json):

```json
{
  "group_name": "dev_team",
  "message":   "Завтра в 14:00 — планёрка. Обязательно всем присутствовать.",
  "api_key":   "sk_test_abc123def456ghi789"
}
```

Успешный ответ (200 OK):
```json
{
  "status": "success",
  "sent_to": ["-1001987654321", "-1001122334455"],
  "message": "Сообщение отправлено"
}
```


Ошибка 400 (Bad Request)
```json
{
  "status": "error",
  "code": 400,
  "message": "Отсутствует обязательное поле: message"
}
```

Ошибка 401 (Unauthorized)
```json
{
  "status": "error",
  "code": 401,
  "message": "Ключ доступа не имеет прав на указанную группу"
}
```

Ошибка 502 (Bad Gateway)
```json
{
  "status": "error",
  "code": 502,
  "message": "Ошибка отправки в чат -1001987654321: бот исключён из группы"
}
```

## Структура базы данных

Для хранения данных используется реляционная база данных. В качестве эталонной реализации рассматривается SQLite, но структура позволяет использовать любую другую СУБД (PostgreSQL, MySQL и др.).

### Таблицы

1. `groups` — мнемонические (человеко-читаемые) имена групп

| Поле       | Тип     | Описание                            | Ограничения      |
|------------|---------|-------------------------------------|------------------|
| id         | INTEGER | Первичный ключ                      | AUTOINCREMENT    |
| group_name | TEXT    | Уникальное мнемоническое имя группы | UNIQUE, NOT NULL |

2. `max_groups` — связь мнемонического имени с реальными идентификаторами чатов MAX

| Поле     | Тип     | Описание                             | Ограничения           |
|----------|---------|--------------------------------------|-----------------------|
| id       | INTEGER | Первичный ключ                       | AUTOINCREMENT         |
| max_id   | INTEGER | ID чата в MAX (обычно отрицательное) | NOT NULL              |
| group_id | INTEGER | Ссылка на запись в таблице groups    | FOREIGN KEY, NOT NULL |

3. `keys` — таблица API-ключей доступа

| Поле    | Тип     | Описание                          | Ограничения      |
|---------|---------|-----------------------------------|------------------|
| id      | INTEGER | Первичный ключ                    | AUTOINCREMENT    |
| api_key | TEXT    | Уникальный строковый ключ доступа | UNIQUE, NOT NULL |

4. `group_api_keys` — связь многие-ко-многим между ключами и группами

| Поле     | Тип     | Описание                          | Ограничения           |
|----------|---------|-----------------------------------|-----------------------|
| key_id   | INTEGER | Ссылка на запись в таблице keys   | FOREIGN KEY, NOT NULL |
| group_id | INTEGER | Ссылка на запись в таблице groups | FOREIGN KEY, NOT NULL |

## Требования к запуску

1. Установленный интерпретатор выбранного языка (референс — Python 3.9+)
2. Установленные зависимости проекта (см. файл `requirements.txt`)
3. Настроенные переменные окружения:

```
BOT_TOKEN=ваш_токен_бота_MAX
DATABASE_URL=sqlite:///maxbot.db
```

или для postgresql:
```
DATABASE_URL=postgresql://user:password@localhost:5432/maxbot
```

4. Инициализация структуры базы данных  
   Выполняется автоматически при первом запуске приложения или вручную с помощью команды / скрипта инициализации.

5. Запуск сервиса (примеры для Python + FastAPI / Flask):

```bash
python main.py
```

## Примеры запросов (curl)
Отправка сообщения в группу:
```bash
curl -X POST http://localhost:8000/send \
  -H "Content-Type: application/json" \
  -d '{
    "group_name": "dev_team",
    "message": "Сегодня в 17:00 — разбор инцидента #4582. Обязательно всем присутствовать.",
    "api_key": "sk_live_9f8e7d6c5b4a3"
  }'
```

Проверка работоспособности
```bash
curl http://localhost:8000/health
```

## Лицензия
Учебный проект — MIT License (при необходимости можно заменить на другую).

Разработано в рамках практического задания по созданию сервисов с внешними интеграциями и управлением доступом.