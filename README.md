# MAX-бот с REST API для рассылки сообщений в группы

Учебный проект: сервис для отправки сообщений в группы мессенджера MAX через собственный REST API с управлением доступом по API-ключам.

## Описание проекта

Сервис предоставляет контролируемый способ отправки текстовых сообщений в заранее заданные группы MAX по мнемоническим именам (алиасам).  
Доступ к рассылке регулируется уникальными API-ключами, каждый из которых может быть привязан к одной или нескольким группам.

Проект предназначен для отработки навыков:
- проектирования и реализации REST API
- работы с базой данных (схема + миграции)
- аутентификации по токену/ключу
- интеграции с внешним мессенджер-API
- обработки ошибок и валидации входных данных

## Основные возможности

- Привязка мнемонических имён групп (`dev_team`, `marketing`, `support`) к реальным ID чатов MAX
- Управление правами отправки сообщений через API-ключи
- Отправка сообщений в одну или несколько групп по мнемоническому имени через HTTP-запрос
- Возврат структурированных JSON-ответов с кодами состояния и описанием ошибок
- Базовая защита от некорректных запросов и ошибок внешнего API

## Текущий REST API

### POST /send

Отправка сообщения в группу(-ы).
**Тело запроса** (application/json) **data.json**:

```json
{
  "group_name": "dev_team",
  "message":   "Завтра в 14:00 — планёрка. Обязательно всем присутствовать.",
  "api_key":   "dtel_test_abc123def456ghi789"
}
```

### Для Windows
```bash
curl -X POST http://127.0.0.1:5000/send -H "Content-Type: application/json" -d @data.json
```
или
```bash
curl -X POST http://127.0.0.1:5000/send -H "Content-Type: application/json" -d "{\"group_name\":\"dev_team\",\"message\":\"Ваш текст\",\"api_key\":\"dtel_api_4c21e12c3f9c4e073b37ca8aaeab0caa\"}"
```

### Для Linux

```bash
curl -X POST http://127.0.0.1:5000/send -H "Content-Type: application/json" -d '{"group_name":"dev_team","message":"Ваш текст","api_key":"dtel_api_4c21e12c3f9c4e073b37ca8aaeab0caa"}'
```
Успешный ответ (200 OK):
```json
{
  "status": "success",
  "sent_to": ["-1001987654321", "-1001122334455"],
  "message": "Сообщение отправлено"
}
```

Ошибка 400 (Bad Request)
```json
{
  "status": "error",
  "code": 400,
  "message": "Отсутствует обязательное поле: message"
}
```

Ошибка 401 (Unauthorized)
```json
{
  "status": "error",
  "code": 401,
  "message": "Ключ доступа не имеет прав на указанную группу"
}
```

Ошибка 502 (Bad Gateway)
```json
{
  "status": "error",
  "code": 502,
  "message": "Ошибка отправки в чат -1001987654321: бот исключён из группы"
}
```

### GET /health

```bash
curl -X GET http://127.0.0.1:5000/health
```
Успешный ответ (200 OK)
```json
{
  "details":{"database":"ok"},
  "run_time_seconds":0.0,
  "status":"online",
  "timestamp_utc":"2026-01-24T22:02:44.495131+03:00"
}
```

## Структура базы данных

Для хранения данных используется реляционная база данных. В качестве эталонной реализации рассматривается SQLite, но структура позволяет использовать любую другую СУБД (PostgreSQL, MySQL и др.).

### Таблицы

1. `groups` — мнемонические (человеко-читаемые) имена групп

| Поле       | Тип     | Описание                            | Ограничения      |
|------------|---------|-------------------------------------|------------------|
| id         | INTEGER | Первичный ключ                      | AUTOINCREMENT    |
| group_name | TEXT    | Уникальное мнемоническое имя группы | UNIQUE, NOT NULL |

2. `max_groups` — связь мнемонического имени с реальными идентификаторами чатов MAX

| Поле     | Тип     | Описание                             | Ограничения           |
|----------|---------|--------------------------------------|-----------------------|
| id       | INTEGER | Первичный ключ                       | AUTOINCREMENT         |
| max_id   | INTEGER | ID чата в MAX (обычно отрицательное) | NOT NULL              |
| group_id | INTEGER | Ссылка на запись в таблице groups    | FOREIGN KEY, NOT NULL |

3. `keys` — таблица API-ключей доступа

| Поле    | Тип     | Описание                          | Ограничения      |
|---------|---------|-----------------------------------|------------------|
| id      | INTEGER | Первичный ключ                    | AUTOINCREMENT    |
| api_key | TEXT    | Уникальный строковый ключ доступа | UNIQUE, NOT NULL |

4. `group_api_keys` — связь многие-ко-многим между ключами и группами

| Поле     | Тип     | Описание                          | Ограничения           |
|----------|---------|-----------------------------------|-----------------------|
| key_id   | INTEGER | Ссылка на запись в таблице keys   | FOREIGN KEY, NOT NULL |
| group_id | INTEGER | Ссылка на запись в таблице groups | FOREIGN KEY, NOT NULL |

## Требования к запуску

1. Установленный интерпретатор выбранного языка (референс — Python 3.9+)
2. Установленные зависимости проекта (см. файл `requirements.txt`)
3. Настроенные переменные окружения:

```
BOT_TOKEN=ваш_токен_бота_MAX
HOST_IP=127.0.0.1
SERVER_PORT=5000
DATABASE_PATH=database/dtel_database.db - Принимает так же http и sqlite
MAX_MESSAGE_LENGTH = 4096
```

4. Инициализация структуры базы данных  
   Выполняется автоматически при первом запуске приложения.

5. Запуск сервиса:
### Шаг 1 | Установка окружения
```bash
python -m venv venv
```
**Шаг 1.1 | Активация окружения**
```
venv\Scripts\activate
``` 
### Шаг 2 | Установка зависимостей
```bash
pip install -r requirements.txt
```
### Шаг 3 | Запуск
```bash
python bot.py
```

## Лицензия
Учебный проект — MIT License.

Разработано в рамках практического задания по созданию сервисов с внешними интеграциями и управлением доступом.